软件 学报 
 JOURNALOFSOFTWARE 
 1999 年 　 第 10 卷 　 第 10 期 　 Vol.10 　 No.10 　 1999 
 
 
 
 
 一个 基于 差值 有界 的 通信量 调度 算法 
 孙 利民 窦 文华 龚正虎 周兴铭 
 
 摘要 　 调度 算法 决定 不同 应用 的 包 在 输出 链路 上 的 发送 顺序 , 是 网络 提供 QoS 服务 的 关键技术 . 该文 给出 了 系统 虚 时钟 和 连接 虚 时钟 差值 有界 的 调度 算法 框架 VDBF ( virtualclockdifference - boundedframework ) . 在 此基础 上 , 采用 周期 修正 系统 虚 时钟 的 方法 和 层次 式 排序 结构 , 提出 了 简单 公平 的 调度 算法 DFQR ( difference - basedfairqueueingbyre - calibration ) . 此 调度 算法 在 网络 延迟 、 调度 公平性 和 实现 复杂度 之间 达到 了 很 好 的 折衷 , 理论 证明 和 模拟 显示 出其 性能 的 优越性 . 
 关键词 调度 算法 , 虚 时钟 差值 有 界 , 周期 修正 , 层次结构 . 
 中图法 分类号 TP393 
 ADifference - basedTrafficSchedulingAlgorithm 
 SUNLi - minDOUWen - huaGONGZheng - huZHOUXing - ming 
 ( DepartmentofComputerScienceNationalUniversityofDefenseTechonolgyChangsha410073 ) 
 AbstractPacketschedulingalgorithmcontrolstheorderofpacketservice , whichiscrucialinthedesignofaQoSnetwork . Inthispaper , theauthorsfirstgiveavirtualclockdifference - boundedframework ( VDBF ) , thenpresentanewschedulingalgorithm — — DFQR ( difference - basedfairqueueingbyre - calibration ) , inwhichtheyuseahierarchicalstructure , recalibratethesystemvirtualclockperiodically , compromisenetworkdelaywithfairnessandimplementationcomplexity . Finally , theydemonstratetheperformancebenefitofDFQRbyanalysisandsimulation . 
 KeywordsSchedulingalgorithm , virtualclockdifference - bounded , recalibrateperiodically , hierarchicalstructure . 
 　 　 调度 算法 决定 不同 应用 的 包 在 输出 链路 上 的 发送 顺序 , 是 网络 提供 QoS 服务 保证 的 关键技术 之一 [ 1 ] . 实用 的 调度 算法 必须 具有 低 网络 延迟 、 良好 的 调度 公平性 和 低 实现 复杂度 等 优点 , 而 目前 提出 的 大量 调度 算法 未能 同时 具有 这些 优点 或 在 以上 几 方面 之间 达到 很 好 的 折衷 [ 2 ] . 我们 在 本文 提出 的 系统 虚 时钟 和 连接 虚 时钟 差值 有 界 调度 算法 框架 VDBF ( virtualclockdifference - boundedframework ) 的 基础 上 , 采用 周期 修正 系统 虚 时钟 的 方法 和 层次 式 排序 结构 , 提出 了 简单 公平 的 调度 算法 DFQR ( difference - basedfairqueueingbyre - calibration ) . 它 在 网络 延迟 、 调度 公平性 和 实现 复杂度 之间 达到 了 很 好 的 折衷 , 具有 较强 的 实用性 . 
 1 　 差值 有界 的 调度 算法 框架 VDBF 
 　 　 定义 1 . 系统 忙 周期 是 指 结点 机 一直 处于 工作 状态 的 最大 时间 间隔 . 在 系统 忙 周期 内 , 结点 机 连续 发送 各 连接 的 包 . 
 　 　 定义 2 . 连接 累积 周期 是 指 连接 在 结点 机中 连续 有包 等待 服务 的 最大 时间 间隔 . 处于 累积 周期 的 连接 称为 累积 连接 . 
 　 　 定义 3 . 连接 i 在 ( t1 , t2 ] 期间 内 获得 的 服务 量 Wi ( t1 , t2 ) 与 预约 带宽 ρ i 之比 , 称为 连接 i 在 ( t1 , t2 ] 期间 获得 的 规格化 服务 , 用 Wi ( t1 , t2 ] 表示 . 
 　 　 我们 在 VDBF 框架 [ 3 ] 中 设置 一个 系统 虚 时钟 P ( t ) 来 描述 系统 状态 , 每个 连接 i 设置 一个 连接 虚 时钟 Pi ( t ) 来 描述 连接 状态 . 其流 模型 描述 如下 . 
 　 　 ( 1 ) 设 输出 链路 的 带宽 为 C , 共享 输出 链路 的 连接 个数 为 N , 连接 i 的 预约 带宽 为 ρ i , 为 保证 网络 的 稳定性 , 存在 关系 . 
 　 　 ( 2 ) 每个 连接 的 虚 时钟 描述 在 t 时刻 连接 的 状态 , 它 具有 以下 特性 : 
 　 　 ( a ) 当 系统 不 处于 忙 周期 时 , 连接 i 的 虚 时钟 设置 为 零 ; 连接 i 不 处于 累积 周期 时 , 连接 i 的 虚 时钟 保持 不变 ; 
 　 　 ( b ) 当 连接 i 在 t1 时刻 进入 累积 周期 时 , 它 的 虚 时钟 为 Pi ( t1 ) = max { P ( t1 - ) , P ( t1 - ) } ; 
 　 　 ( c ) 在 累积 周期 ( t1 , t2 ] 期间 , 连接 i 在 t ∈ ( t1 , t2 ) 时 的 虚 时钟 为 Pi ( t1 ) = Pi ( t1 ) + Wi ( t1 , t ) . 
 　 　 ( 3 ) 系统 的 虚 时钟 描述 在 t 时刻 系统 的 状态 , 它 具有 以下 特性 : 
 　 　 ( a ) 当 系统 不 处于 忙 周期 时 , 系统 虚 时钟 设置 为 零 ; 在 系统 忙 周期 的 任意 区间 ( t1 , t2 ] , 
 P ( t2 ) - P ( t1 ) t2 - t1 ； 
 　 　 ( b ) 在 任何时刻 系统 虚 时钟 都 不 大于 任何 处于 累积 周期 的 连接 虚 时钟 , 如果 B ( t ) 表示 t 时刻 处于 累积 周期 的 连接 集合 , 那么 
 P ( t ) minPi ( t ) , i ∈ B ( t ) ; 
 　 　 ( c ) 在 任何时刻 , 系统 虚 时钟 与 任何 处于 累积 周期 的 连接 虚 时钟 之差 有界 , 即 
 Pi ( t ) － P ( t ) △ P , 　 　 　 △ P 为 常量 . 
 　 　 ( 4 ) 系统 选择 累积 连接 服务 策略 为 : 系统 在 t 时刻 只 服务 虚 时钟 最小 的 累积 连接 集合 , 该 集合 各 连接 获得 的 服务 速率 正比 于 它们 的 预约 带宽 . 
 　 　 流 模型 中 多个 连接 以 不同 速率 可 同时 获得 服务 , 而包 模型 中 任意 时刻 只能 有 一个包 获得 服务 . 在 VDBF 相应 的 包 模型 系统 中 , 每个 包 带有 虚拟 完成 时间 , 包 的 虚拟 完成 时间 是 包 的 最后 一位 离开 流 模型 系统 时 连接 的 虚 时钟 值 , 系统 选择 虚拟 完成 时间 最小 的 到达 包 服务 . 可以 验证 WFQ [ 4 ] 和 VC [ 5 ] 调度 算法 符合 VDBF 框架 . 
 　 　 由 VDBF 框架 构造 的 包 调度 算法 称为 PDFQ ( packet _ by _ packetdifference _ basedfairqueueing ) 调度 算法 . PDFQ 调度 算法 具有 如下 特性 . 
 　 　 性质 1 . 在 PDFQ 服务器 中 , Lmax 表示 所有 连接 中 最大 包 的 长度 , 如果 连接 i 的 到达 通信量 符合 漏桶 模型 ( σ i ρ i ) , 那么 , 连接 i 的 包 延迟 满足 . 
 　 　 定义 4 ( 调度 算法 公平性 ) . 在 系统 忙 周期 内 , 对于 任意 时间 间隔 ( t1 , t2 ) 内 连续 处于 累积 周期 的 任意 两个 连接 i 和 j , 如果 连接 i 和 j 在 ( t1 , t2 ) 期间 获得 的 规格化 服务 之差 有界 , 即 ( F 为 常量 ) , 那么 调度 算法 具有 公平性 , F 值越 小 公平性 就 越 好 , 理想 情况 F 等于零 . 
 　 　 如果 Li 表示 连接 i 最大 包 长度 , 表示 连接 i 在 ( t1 , t2 ] 期间 内 获得 的 包括 非 完整包 服务 量 . PDFQ 算法 的 调度 公平性 如下 . 
 　 　 性质 2 . 在 PDFQ 服务器 中 , 如果 连接 i 和 j 在 τ 时刻 后 一直 处于 累积 周期 , 那么 对于 τ 时刻 后 的 任意 时间 间隔 ( t1 , t2 ] , 满足 关系 : 
 . 
 其中 , △ P 是 系统 虚 时钟 与 连接 虚 时钟 之差 的 最大值 . 
 2 　 DFQR 调度 算法 
 　 　 VDBF 框架 规定 了 系统 虚 时钟 和 连接 虚 时钟 的 特性 以及 连接 虚 时钟 的 计算方法 . 符合 VDBF 框架 的 调度 算法 具有 相同 的 低 网络 延迟 , 但 调度 公平性 存在 差异 . 根据 VDBF 框架 具体 构造 调度 算法 的 核心 问题 是 系统 虚 时钟 的 计算 , 使用 不同 的 系统 虚 时钟 计算方法 , 算法 的 实现 复杂度 和 调度 公平性 不同 . 调度 算法 复杂度 主要 包括 包 的 虚拟 完成 时间 计算 以及 包 的 排序 和 选择 发送 . 系统 虚 时钟 的 计算 决定 虚拟 完成 时间 计算 复杂度 . 基于 实现 简单 和 调度 公平 考虑 , 我们 采用 如下 周期 修正 系统 虚 时钟 的 方法 . 
 2.1 系统 虚 时钟 的 周期性 修正 方法 
 　 　 设置 , △ D 是 包 模型 下 连接 虚 时钟 差值 的 最小 上界 . 
 　 　 如果 系统 虚 时钟 按 真实 时间 增加 , 那么 它 的 计算 很 简单 , 但 存在 系统 虚 时钟 与 连接 虚 时钟 之差 可 大于 任意 值 而 造成 调度 公平性 差 的 问题 . 为了 计算 系统 虚 时钟 简单 和 调度 公平性 好 , 系统 虚 时钟 通常 按照 真实 时间 增加 , 当 系统 虚 时钟 与 连接 虚 时钟 之差 超过 一定 值时 , 及时 修正 系统 虚 时钟 . 在 包 模型 下 , 采用 独立式 方法 * 计算 系统 虚 时钟 实现 简单 , 系统 虚 时钟 的 修正 只能 在 包 到达 或 离开 时 发生 . 
 　 　 假设 系统 虚 时钟 在 系统 忙 周期 开始 时 设置 为 零 , 而且 按照 真实 时间 增加 , 连接 虚 时钟 的 计算 和 选择 连接 的 服务 按照 VDBF 框架 规定 . 在 其 相应 的 包 模型 下 , 每个 包 的 虚拟 完成 时间 等于 在 流 模型 下包 的 最后 一位 完成 服务 时 连接 的 虚 时钟 值 , 结点 机 选择 虚拟 完成 时间 最小 的 包 发送 . 在 包 模型 下 发送 完成 包 时刻 ( 记为 Tf 时刻 ) , 用 p _ h 表示 所有 累积 连接 中未 获得 服务 的 虚拟 完成 时间 最小 的 包 , Fp _ h 表示 p _ h 的 虚拟 完成 时间 , 存在 下面 的 关系 . 
 　 　 定理 1 . 在 包 模型 下 , 在 发送 完成 包 Tf 时刻 存在 如下 关系式 : 
 Pi ( Tf ) Fp _ h - △ D , i ∈ B ( Tf ) . 
 　 　 证明 : 反证法 . 假设 累积 连接 j 的 虚 时钟 值 不 满足 上述 关系式 , 即 
 Pj ( Tf ) < Fp _ h - △ D , j ∈ B ( Tf ) . 
 　 　 在 Tf 时刻 , 设 连接 j 在 结点 机中 未 获得 服务 的 最先 到达 的 包为 连接 j 的 第 k 个 包 , 那么 , 
 , 
 因此 Fk , j < Fp _ h . 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 □ 
 　 　 这 与 已知 p _ h 是 未 获得 服务 的 虚拟 完成 时间 最 小包 矛盾 , 即证 . 
 　 　 在 包 模型 下 , 在 发送 完成 包 时刻 ( Tf ) , 如果 Fp _ h ＞ P ( Tf - ) + △ D , j ∈ B ( Tf ) . ( 此 Tf 时刻 记为 TR 时刻 ) , 由 定理 1 可知 , 所有 累积 连接 的 虚 时钟 值 都 大于 ( Fp _ h － △ D ) , 而 系统 虚 时钟 P ( Tf － ) 小于 ( Fp _ h － △ D ) , 可 将 系统 虚 时钟 修正 为 P ( Tf ) = Fp _ h － △ D . 周期 修正 系统 虚 时钟 的 方法 具体 描述 为 : 
 　 　 ( 1 ) 在 系统 忙 周期 开始 , 设置 系统 虚 时钟 为 零 ; 
 　 　 ( 2 ) 在 每个 包 发送 完成 时刻 Tf , 判断 结点 机中 未 服务 包 的 最小 虚拟 完成 时间 是否 比 系统 虚 时钟 值大 △ D , 即 Fp _ h ＞ P ( Tf - ) ＋ △ D , 若 关系式 成立 , 修正 系统 虚 时钟 为 P ( Tf ) ＞ Fp _ h － △ D , 否则 不 修正 ; 
 　 　 ( 3 ) 其他 时刻 P ( t ) = P ( t1 ) + t - t1 , ( t1 , t ] 属于 系统 忙 周期 . 
 　 　 定理 2 . 在 包 模型 下 , 采用 周期 修正 的 计算 系统 虚 时钟 方法 , 在 发送 完成 包 时刻 Tf , 存在 关系 : 
 Pi ( Tf ) ＜ P ( Tf ） ＋ △ D , i ∈ B ( Tf ) . 
 　 　 证明 : 反证法 . 假设 Pj ( Tf ) P ( Tf ) + △ D , j ∈ B ( Tf ) , 在 时刻 Tf , 连接 j 必 存在 一个 已经 发送 完成 的 包 ( 设为 第 k 个 包 ) , 它 的 虚拟 完成 时间 为 Pj ( Tf ） . 考虑 连接 j 第 k 个 包 在 时刻 t ( t < Tf ) 成为 p _ h , 此时 , 
 Fp _ h = Pj ( Tf ） P ( Tf ) + △ D . 
 由于 P ( t ) ＜ P ( Tf ) ( t ＜ Tf ) , 因此 Fp _ h ＞ P ( t ) + △ D . , 在 t 时刻 需要 修正 系统 虚 时钟 为 
 P ( t ) = Fp _ h - △ D = Pj ( Tf ） Pj ( Tf ) - △ D , ( t 时刻 ) 
 即 Pj ( Tf ) = P ( t ) + △ D , 
 所以 , Pj ( Tf ) ＜ P ( Tf ) + △ D , P ( t ) ＜ P ( Tf ) . 
 　 　 这 与 已知 假设 相 矛盾 , 即证 . 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 □ 
 　 　 由 定理 1 和 定理 2 可知 : 在 包 模型 下 , 如果 采用 周期 修正 的 计算 系统 虚 时钟 方法 , 那么 在 发送 完成 包 时刻 Tf , 所有 累积 连接 的 虚 时钟 值 都 小于 ( P ( Tf ) + △ D ) 且 都 大于 ( Fp _ h - △ D ) , 系统 虚 时钟 与 连接 虚 时钟 之差 小于 △ D . 
 　 　 在 相应 流 模型 下 的 调度 算法 中 , 连接 虚 时钟 最小 的 所有 累积 连接 同时 获得 服务 , 所有 累积 连接 的 虚 时钟 值 趋近 相同 . 在 包 模型 下 , 后 到达 的 虚拟 完成 时间 小 的 包 不能 剥夺 正在 发送 的 包 ; 在 流 模型 下 , 后 到达 ( 包 ) 的 虚 时钟 值 小 的 累积 连接 可 剥夺 正在 发送 的 连接 . 因此 , 对于 任意 给定 时刻 , 流 模型 下 最小 的 累积 连接 虚 时钟 不 小于 包 模型 下该 连接 的 虚 时钟 值 ; 流 模型 下 最大 的 累积 连接 虚 时钟 不 大于 包 模型 下该 连接 的 虚 时钟 值 ; 流 模型 下 累积 连接 虚 时钟 之间 的 差值 比 在 包 模型 下 小 . 因为 包 模型 下 TR 时刻 , 所有 累积 连接 的 虚 时钟 值 都 小于 ( P ( TR ) + △ D ) 值且 都 大于 ( Fp _ h - △ D ) 值 , 所以 , 在 流 模型 下 TR 时刻 , 所有 累积 连接 的 虚 时钟 值 也 都 小于 ( P ( TR ) + △ D ) 值且 都 大于 ( Fp _ h - △ D ) 值 , 此时 可 将 系统 虚 时钟 修改 为 ( Fp _ h - △ D ) . 这样 修改 系统 虚 时钟 , 一方面 符合 VDBF 框架 的 条件 , 另一方面 保持 两种 模型 下 系统 虚 时钟 相同 . 
 　 　 定理 3 . 对于 流 模式 下 的 调度 算法 , 如果 按照 VDBF 框架 计算 连接 虚 时钟 及 选择 连接 服务 , 采用 周期 修正 的 系统 虚 时钟 计算方法 , 那么 : 
 　 　 1 ° 在 系统 忙 周期 的 任何 区间 ( t1 , t2 ] , P ( t2 ) - P ( t1 ) t2 - t1 ; 
 　 　 2 ° 在 系统 忙 周期 的 任意 时刻 t , P ( t ) Pi ( t ) , i ∈ B ( t ) ; 
 　 　 3 ° 在 系统 忙 周期 的 任意 时刻 t , Pi ( t ) - P ( t ) △ D , i ∈ B ( t ) ; 
 　 　 证明 : 1 ° 分 两种 情况 : 
 　 　 ( 1 ) 在 ( t1 , t2 ] 期间 , 没有 修正 系统 虚 时钟 , 那么 P ( t2 ) = P ( t1 ) + t2 - t1 , 满足 关系式 . 
 　 　 ( 2 ) 在 ( t1 , t2 ] 期间 , 如果 在 时刻 τ 1 τ 2 … τ m 修正 了 系统 虚 时钟 , 也 就是 在 τ k = ( k = 1 , 2 , ... , m ) 时 , P ( τ k ) = Fp _ h - △ D ＞ P ( τ k - ) , 那么 P ( t2 ) = P ( τ m ) + t2 - τ m ＞ P ( τ m - ) + t2 - τ m ＞ P ( τ m - 1 - ) + t2 - τ m - 1 , 递推 可得 P ( t2 ) ＞ P ( τ 1 - ) + t2 - t1 ＞ P ( t1 ) + t2 - t1 , 满足 关系式 . 
 　 　 2 ° 反证法 . 假设 在 系统 忙 周期 ｔ 时刻 有 i ∈ B ( t ) , P ( t ) ＞ Pi ( t ) , 考虑 离 t 最近 的 时刻 t - △ tPi ( t - △ t ) , 连接 i 在 ( t - △ t , t ] 期间 处于 累积 周期 . 分 两种 情况 : 
 　 　 ( 1 ) 在 ( t - △ t , t ] 期间 没有 修正 系统 虚 时钟 值 . 连接 i 在 ( t - △ t , t ] 期间 是 虚 时钟 值 最小 的 连接 , 它 获得 服务 的 速率 不 小于 ρ i , 因此 , , , 这 与 假设 相 矛盾 , 所以 P ( t ) ＜ Pi ( t ) . 
 　 　 ( 2 ) 在 t 时刻 修正 系统 虚 时钟 , 则 存在 关系式 : P ( t - ) ＜ Fp _ h - △ DPi ( t - ) , 系统 虚 时钟 修正 为 P ( t ) = Fp _ h - △ D , 而 Pi ( t ) = Pi ( t - ) , 所以 P ( t ) Pi ( t ) . 
 　 　 3 ° 由 周期 修正 系统 虚 时钟 方法 可知 : 连接 与 系统 的 虚 时钟 之差 最大值 是 在 修正 系统 虚 时钟 的 时刻 之前 . 如果 在 时刻 t 修正 系统 虚 时钟 值 , 则 存在 关系式 : 
 P ( t - ) ＜ Fp _ h - △ DPi ( t - ) ＜ P ( t - ) + △ D , 　 i ∈ B ( t - ) , 
 因而 Pi ( t ) - P ( t - ) △ D , 　 　 i ∈ B ( t － ) , 
 所以 , 对于 系统 忙 周期 的 任意 时刻 t , Pi ( t ) = P ( t ) △ D , i ∈ B ( t ) . 
 　 　 推论 . 在 流 模型 下 , 如果 采用 周期 修正 系统 虚 时钟 的 方法 , 并 按照 VDBF 框架 计算 连接 虚 时钟 及 选择 连接 服务 , 那么 该 调度 算法 符合 VDBF 框架 , 且 △ P = △ D . 
 2.2 层次 式 优化 排序 策略 
 对 每个 连接 而言 , 按照 包 到达 的 先后顺序 服务 , 只 需 连接 在 结点 机中 未 服务 的 最先 到达 的 包 参加 排序 . 我们 采用 如下 层次 式 排序 策略 : 每个 连接 设置 一个 等待 队列 , 按照 到达 先后顺序 存放 属于 该 连接 的 包 ; 系统 设置 一个 公共 等待 队列 , 所有 连接 在 结点 机中 未 服务 的 最先 到达 的 包 存放 到 公共 等待 队列 中 , 它们 按照 虚拟 完成 时间 从小到大 排序 , 这样 , 包 的 排序 复杂度 为 O ( log2N ) . 结点 机 选择 公共 等待 队列 中 虚拟 完成 时间 最小 的 包 发送 , 如果 发送 包 对应 的 连接 队列 中 仍 有 包 , 计算 它 第 1 个 包 的 虚拟 完成 时间 后 插入 公共 等待 队列 中 . 
 2.3 DFQR 调度 算法 
 　 　 在 具体 给出 算法 之前 , 首先 说明 以下几点 : pub _ queue 表示 按照 虚拟 完成 时间 从小到大 排序 包 的 公共 等待 队列 ; 
 　 　 i _ queue 表示 连接 i 按照 到达 先后 排序 包 的 等待 队列 ; Fp _ h ( t ) 表示 t 时刻 pub _ queue 中未 服务 包 的 最小 虚拟 完成 时间 ; Fi 表示 当前 时刻 连接 i 最近 发送 包 的 虚拟 完成 时间 , 系统 忙 周期 开始 设置 为 零 . 
 　 　 系统 虚 时钟 计算 : 
 　 　 ( 1 ) 在 系统 忙 周期 开始 时刻 , 设置 系统 虚 时钟 P ( t ) 为 零 ; 
 　 　 ( 2 ) 在 系统 忙 周期 内除 修正 系统 虚 时钟 P ( t ) 时刻 外 , 系统 虚 时钟 P ( t ) 按 真实 时间 增加 . 
 　 　 包 离开 算法 : 假设 连接 i 的 第 k 个 包 t 时刻 发送 完成 . 
 　 　 ( 1 ) 修改 系统 虚 时钟 值 : 
 　 　 　 　 　 if ( pub _ queue 为空 ) 
 　 　 　 　 　 　 then { P ( t ) = 0 ; 
 　 　 　 　 　 　 Fi = 0 ; i ∈ C ( t ) , C ( t ) 是 共享 输出 链路 的 连接 集合 
 　 　 　 　 　 　 exit ( ) } 
 　 　 　 else { if ( Fp _ h ＞ P ( t ) + △ D ) 
 　 　 　 　 　 　 　 　 thenP ( t ) = Fp _ h - △ D 
 　 　 　 　 　 　 endif } 
 　 　 　 endif 
 　 　 ( 2 ) 设 pub _ queue 中 连接 j 第 m 个 包 的 虚拟 完成 时间 最小 , 选择 该包 发送 ; 
 　 　 ( 3 ) Fj ＝ Fm , j 
 　 　 ( 4 ) if ( j _ queue 非空 ) 
 　 　 　 then { 计算 连接 j 第 ( m + 1 ) 包 的 虚拟 完成 时间 ; 
 　 　 　 　 　 　 根据 虚拟 完成 时间 将 连接 j 第 ( m + 1 ) 个 包 插入 pub _ queue 中 } 
 　 　 　 endif 
 　 　 包 到达 算法 : 假设 连接 i 第 ( k + 1 ) 个 包 在 t 时刻 到达 . 
 　 　 　 　 if ( ( i _ queue 为空 ) and ( pub _ queue 没有 连接 i 的 包 ) ) 
 　 　 　 　 　 then { ; 
 　 　 　 　 　 　 　 　 根据 虚拟 完成 时间 将 该 包 插入 pub _ queue 中 } 
 　 　 　 　 　 else 根据 到达 顺序 将 包 存放 在 i _ queue 中 
 　 　 　 　 endif 
 3 　 与 其他 调度 算法 的 比较 与 性能 模拟 
 3.1 与 其他 调度 算法 的 比较 
 　 　 从表 1 可以 看到 DFQR 算法 的 延迟 边界 与 WFQ 相同 , 实现 复杂度 与 VC 相同 , 调度 公平性 也 比 PFFQ [ 3 ] 调度 算法 好 . 
 表 1 调度 算法 的 延迟 、 公平性 和 实现 复杂度 比较 
 
 调度 算法 延迟 公平性 复杂度 
 WFQ σ i / ρ i + Lmax / CFi , j ( 0 ) O ( N ) 
 VC σ i / ρ i + ( Lmax / C ) ∞ O ( logN ) 
 SCFQ σ i / ρ i + Lmax / C ( N - 1 ) Li / ρ i + Lj / ρ jO ( logN ) 
 DFQR σ i / ρ i + Lmax / CFi , j ( Δ D ) O ( logN ) 
 PFFQ σ i / ρ i + Lmax / CFi , j ( 2 . Δ D ) O ( logN ) 
 
 　 
 表中 , 　 　 
 　 　 　 　 　 . 
 3.2 性能 模拟 公平性 
 　 　 延迟 模拟 模型 为 8 个 连接 共享 输出 链路 , 连接 的 通信量 符合 ON _ OFF 模型 并 经过 漏桶 整形 . 表 2 给出 调度 算法 在 包 长度 为 1 ( 模拟 ATM ) 时 连接 最大 延迟 统计 结果 . 从表 2 看到 : 各 连接 的 最大 延迟 小于 理论 上 的 延迟 边界 ; 占 带宽 50% 以上 的 连接 1 在 DFQR 调度 算法 中 的 最大 延迟 介于 SCFQ ( PFFQ ) 与 WFQ ( VC ) 之间 ; 预约 带宽 是 控制 连接 延迟 的 关键因素 , 通过 稍微 调整 连接 的 预约 带宽 就 可 改变 连接 的 延迟 . 
 表 2 调度 算法 最大 延迟 统计 结果 ( σ i = 2 , Lmax = 1 ) 
 
 连接 预约 带宽 到达 速率 VC 等 理论值 SCFQ 理论值 VCWFQDFQRPFFQSCFQ 
 10.5000000 . 4985111.801 . 601.804 . 007.20 
 20.0625000 . 061333920.0018 . 0023.0022 . 0023.00 
 30.0625000 . 062333922.0019 . 0024.0025 . 0024.00 
 40.0625000 . 062333923.0021 . 0025.0027 . 0031.00 
 50.0781250 . 076273312.4012 . 6016.4018 . 4017.60 
 60.0781250 . 076273314.8013 . 2017.8019 . 4018.60 
 70.0781250 . 076273315.8013 . 6018.8020 . 4019.60 
 80.0781250 . 076273319.8015 . 6019.8021 . 2021.60 
 
 　 
 　 　 通过 比较 在 同一 段时间 内 连接 获得 的 规格化 服务 之差 评价 调度 算法 的 公平性 , 规格化 服务 之差 最大值 通常 发生 在 有 连接 刚 进入 累积 周期 后 的 时间段 . 为了 测试 算法 的 公平性 , 我们 将 连接 分为 奇数 和 偶数 两组 , 两组 中 对应 连接 的 预约 带宽 相同 , 各 连接 的 通信量 较大 以 保证 在 任何时刻 连接 都 处于 累积 周期 . 奇 数组 连接 包在 t = 0 开始 到达 , 偶数 组 连接 包在 t = 1000 开始 到达 , 统计 每 100 个 时间 单位 时 各 连接 发送 包 的 个数 , 连接 1 和 连接 2 在 时间 间隔 ( 700 , 1800 ] 内 的 统计 结果 如图 1 所示 . 图中 显示 出 VC 调度 的 公平性 差 , 其他 调度 算法 的 结果 基本 相近 . 近 一步 的 实验 说明 DFQR 算法 的 公平性 介于 PFFQ 与 WFQ 之间 . 
 
 图 1 　 连接 1 和 连接 2 在 不同 调度 算法 下 发送 包 的 个数 ( 时间 间隔 : 100s ) 
 4 　 小结 
 　 　 本文 在 差值 有界 的 调度 算法 VDBF 框架 基础 上 , 通过 周期 修正 系统 虚 时钟 , 采用 层次 式 优化 排序 结构 , 并 提出 了 DFQR 调度 算法 . 理论 分析 和 性能 模拟 显示 , DFQR 调度 算法 具有 低 网络 延迟 、 较 好 的 调度 公平性 和 实现 简单 的 优点 , 在 网络 延迟 、 公平性 和 实现 复杂度 之间 达到 好 的 折衷 . PFFQ 调度 算法 已 在 ATM 交换机 中 用 硬件 实现 . DFQR 调度 算法 比 PFFQ 算法 公平性 好 , 实现 更为 简单 , 这 说明 DFQR 调度 算法 完全 可以 用 硬件 实现 , 用 在 高速 的 结点 机中 , 是 一个 较为 实用 的 高性能 调度 算法 . 
 注释 ： 本文 研究 得到 国家 863 高科技 项目 基金 资助 。 
 作者简介 ： 孙 利民 ： 1966 年生 , 博士后 , 主要 研究 领域 为 高速 计算机网络 , 实时 通信 
 　 　 　 　 　 窦 文华 : 1946 年生 , 教授 , 博士生 导师 , 主要 研究 领域 为 高性能 网络 技术 
 　 　 　 　 　 龚正虎 : 1945 年生 , 教授 , 博士生 导师 , 主要 研究 领域 为 网络 互连 , QoS 技术 
 　 　 　 　 　 周兴铭 : 1938 年生 , 教授 , 博士生 导师 , 中国科学院 院士 , 主要 研究 领域 为 高性能 机 体系 　 　 　 　 　 　 统 结构 , 高速 计算机网络 , 分布式 数据库 
 作者 单位 ： 国防科学技术大学 计算机系 长沙 410073 ) 
 参考文献 
 1 　 ZhangHui . Servicedisciplinesforguaranteedperformanceservicein 
 　 　 packet - switchingnetworks . ProceedingsofIEEE , 1995 , 83 ( 10 ) : 1373 ～ 1396 
 2 　 StiliadisD , VarmaA . Frame - basedfairqueueing : anewtrafficscheduling 
 　 　 algorithmforpacket - switchednetworks . TechnicalReport , UCSC - CRL - 95 - 39 , 1995 . 
 　 　 http : / / www . cse . ucsc . edu / research / hanlab / publications / 
 3 　 孙 利民 . 有界 延迟 实时 服务网络 的 研究 [ 博士学位 论文 ] . 国防科学技术大学 计算机系 , 1998 
 　 　 ( SunLi - min . Real - timenetworkswithbound - delayserviceguarantees [ Ph . D . 
 　 　 Thesis ] . NationalUniversityofDefenseTechnology , 1998 ) 
 4 　 ParekhA , GallagerR . Ageneralizedprocessorsharingapproachtoflowcontrolin 
 　 　 integratedservicesnetworks : thesingle - nodecase . IEEE / ACMTransactionson 
 　 　 Networking , 1993 , 1 ( 3 ) : 344 ～ 357 
 5 　 FigueiraNR , PasqualeJ . Anupperboundondelayforthevirtualclockservice 
 　 　 discipline . IEEE / ACMTransactionsonNetworking , 1995 , 3 ( 4 ) : 399 ～ 408 
 6 　 GolestaniSJ . Networkdelayanalysisofaclassoffairqueueingalgorithms . 
 　 　 IEEEJournalonSelectedAreasinCommunication , 1995 , 13 ( 8 ) : 1057 ～ 1570 
 收稿 日期 ： 1998 - 07 - 13 修稿 日期 ： 1998 - 10 - 16 
