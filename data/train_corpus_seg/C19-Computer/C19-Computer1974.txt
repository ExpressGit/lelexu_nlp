微型机 与 应用 
 MICROCOMPUTER & ITSAPPLICATIONS 
 1999 年 第 18 卷 第 2 期 Vol.18 No.21999 
 
 
 
 基于 PC 总线 的 高精度 频率 测量 卡 设计 
 张志明 　 李蓉艳 
 　 　 摘 　 要 ： 本文 应用 等 精度 测频 原理 ， 设计 了 基于 PC 总线 的 高精度 频率 测量 卡 。 克服 了 一般 直接 测频法 在 低频 段 精度 不高 的 缺陷 ， 实现 了 在 整个 测量 频段 保持 高精度 不变 的 目标 。 给出 了 等 精度 测频 电路图 和 软件 功能 子程序 图 。 
 　 　 关键词 ： PC 总线 　 频率 测量 　 等 精度 测量 　 PC 集成 仪器 
 　 　 谐振 式 传感器 是 利用 某种 谐振器 的 固有频率 随 被 测 物理量 ( 如 力场 、 压力 、 加速度 、 电场 、 磁场 、 温度 、 气体 量 等 ) 的 变化 而 变化 的 原理 ， 由 精确测量 频率 的 变化 来 度量 上述 物理量 的 变化 。 因 其 输出 信号 为 频率 型 信号 ， 具有 适合 远距离 传输 、 便于 与 数字 计算机系统 连接 、 抗干扰性 好 等 优点 。 本文 介绍 的 传感器 频率 信号 检测仪 和 微机 系统 相结合 ， 用来 精确测量 谐振 式 传感器 输出 频率 信号 ， 并 将 其 转换 为 待 测量 ， 具有 数据处理 、 存储 功能 。 该 测量 卡 还 可 作为 电子 通用 计数器 使用 。 
 1 　 工作 原理 
 　 　 高精度 频率 测量 是 频率 信号 检测仪 的 关键 。 传统 的 直接 测频法 ， 由于 被测 频率 信号 与 阀门 时间 的 不 同步 存在 较大 的 计数 误差 ， 此 误差 在 整个 频率 测量范围 内 对 测频 精度 影响 不同 ， 特别 在 低频 时测频 精度 很 低 。 采用 等 精度 测频法 克服 了 这 一 缺点 。 其 原理 是 采用 多 周期 同步 测量 原理 ， 即 在 整数 个 被 测 信号 周期 内 计数 频标 信号 ， 经 运算 求得 被测 频率 值 。 采用 这种 方法 在 整个 频率 范围 内 可 获得 同样 高 的 精度 和 分辨率 。 
 
 
 图 1 　 等 精度 频率 测量法 时序 图 
 　 　 图 1 是 等 精度 测频法 的 时序 图 。 当测频 预置 门 打开 ， 即当 测频 允许 信号 有效 ( TQ ＝ 1 ) 后 ， 计数 阀门 并 不是 立即 打开 ， 计数器 A 、 B 也 没有 立即 开始 计数 ， 而是 在 此后 的 第 1 个 被 测 信号 有效 沿 到来 后 才 打开 计数 阀门 ， 开始 计数 ； 当 计数 到 阀门 时间 预定 值时 ， 发出 预置 门 关闭 即 测频 允许 无效 信号 ( TQ ＝ 0 ) ， 但 这时 计数 阀门 仍 未 关闭 ， 计数器 A 、 B 也 没有 停止 计数 ， 而是 在 此后 的 下 一个 被测 信号 有效 沿 到来 后 才 关闭 计数 阀门 ， 停止 计数 。 实际 的 阀门 时间 为 T ， 这样 就 保证 了 被 测 信号 与 阀门 时间 的 同步 。 显然 ， 在 时间 T 内 ， A 计数器 对 被 测 信号 的 计 数值 NA 和 B 计数器 对 时钟 频标 信号 的 计 数值 NB 分别 为 ： 
 　 　 NA ＝ Fx × T 
 　 　 NB ＝ F0 × T 
 　 　 被测 信号 频率 为 ： 
 　 　 Fx = F0 × NA / NB 
 　 　 由 上 分析 可知 ， 被测 信号 与 阀门 信号 的 同步 ， 保证 了 阀门 时间 T 准确 地 等于 被测 信号 周期 的 整数倍 ， 因此 计 数值 NA 没有 ± 1 计数 误差 。 所以 等 精度 测频法 的 误差 可以 表示 为 ： 
 　 　 Δ Fx / Fx = Δ F0 / F0 + Δ NB / NB 
 　 　 由 上式 可知 ， 等 精度 测频法 的 误差 主要 有 2 项 ： 频标 信号 误差 Δ F0 / F0 和 B 计数器 计数 误差 Δ NB / NB 。 由于 时钟 频标 信号 F0 很 高 ( 10MHz ) ， 基数 NB ＞ ＞ 1 ， 故 B 计数器 的 ± 1 个 字 误差 ( Δ NB ＝ ± 1 ) 引起 的 计数 误差 Δ NB / NB 很小 ； 另外 基准 晶体振荡器 的 精度 很 高 ， 频标 信号 误差 Δ F0 / F0 很小 ， 所以 等 精度 测频法 具有 很 高 的 精度 。 同时 可以 看出 ， 在 输入 信号 无 噪声 ， 触发 误差 和 频标 误差 可 忽略不计 的 情况 下 ， 等 精度 测频 误差 只 取决于 频标 信号 的 计数 测量误差 ， 而 与 被 测 信号 频率 无关 。 因此 ， 在 整个 频率 测量范围 测量 精度 均等 ， 分辨率 很 高 。 
 　 　 与 普通 计数器 / 频率计 的 电路 相比 ， 采用 等 精度 测频 原理 的 电路 结构复杂 、 体积 庞大 ， 但若用 微型 计算机 来 实现 其 运算 和 控制 功能 ， 则 是 简单 和 方便 的 ， 只要 利用软件 就 可 替代 复杂 的 硬件 电路 。 本文 论述 的 频率 信号 检测 系统 即 以此 为 原则 ， 和 PC 微机 系统 相结合 而 设计 。 
 2 　 硬件 电路 
 　 　 智能 等 精度 频率 信号 检测 系统 的 硬件 主要 由 5 部分 电路 组成 ： PC 微机 及其 接口 电路 、 输入 信号 通道 ( 包括 光 耦 隔离 通道 、 非光 耦 信号 通道 和 通道 选通门 ) 、 同步 门电路 ( 包括 同步 门 、 同步 门 控制器 和 阀门 时间 控制器 ) 、 计数器 ( 包括 事件 计数器 、 时间 计数器 ) 、 频标 发生 电路 ( 石英 晶体 TCXO 振荡电路 及 外部 频标 接口 ) 。 系统 的 整机 框图 如图 2 。 
 
 
 图 2 　 等 精度 频率计 整机 框图 
 　 　 下面 仅 对 实现 等 精度 测频 原理 的 主要 电路 ： 同步 门电路 和 计数器 部分 作一 说明 。 
 　 　 输入 信号 及 频标 信号 经 74HC14 施密特 高速 反相器 缓冲 后 ， 由 同步 门 和 同步 门 控制器 同步 后 ， 进入 计数器 电路 进行 计数 。 等 精度 频率 测量法 设计 电路 中 采用 2 个 计数器 分别 对 被 测 信号 Fx 和 频标 信号 F0 计数 ； 同步 门 控制电路 保证 阀门 开启 时间 与 被 测 信号 同步 。 
 2.1 　 同步 门及 同步 门 控制器 
 　 　 同步 门 控制器 是 一个 带 预置 和 清除 的 D 触发器 。 D 端接 阀门 测量 时间 控制 信号 ； CLR 端接 复位 信号 ； Q 端 输出 门控 信号 控制 同步 门 与 门 74HC08 。 被测 信号 同时 发送至 D 触发器 的 CLK 端 和 同步 门 输入 端 ， 起到 同步控制 作用 。 
 
 图 3 同步 门 与 同步 门 控制器 
 　 　 阀门 时间 控制器 由 CTC8254 的 通道 2 和 前级 分频 计数器 74HC393 组成 ， 向 测量 电路 提供 预置 阀门 信号 时间 。 预置 阀门 从 0.01 ～ 10.0 s 可 任选 。 当 预置 阀门 时间 较长 时 ， CTC — 2 通道 作为 单位 时间 循环体 ， 循环 次数 由 软件 控制 。 
 2.2 　 计数器 
 　 　 频率 测量 部分 是 本 仪器 的 关键 ， 由 可编程 三 通道 CTC8254 计数器 和 前级 计数器 组成 ， 其中 CTC8254 共有 3 个 计数 通道 ， 分别 作为 时间 计数器 NA 、 事件 计数器 NB 和 阀门 时间 定时器 NC ， 分别 用于 对 被 测 频率 信号 Fx 、 频标 信号 F0 计数 和 对 阀门 时间 TQ 定时 以 准确 求得 频率 值 。 CTC8254 计数器 的 3 个 输出 端 与 微机 中断请求 信号线 相连 ， 在 计数 溢出 后 ， 8254 输出 脉冲 信号 ， 引起 中断 。 使用 硬件 计数 可以 避免 使用 软件 计数器 带来 的 时间误差 。 又 由于 硬件 计数器 溢出 值 的 限制 ， 我们 采用 软硬件 结合 的 方法 来 扩展 计数 范围 ： 当 8254 计数器 回零 溢出 进位 时 发生 PC机 硬件 中断 ， CPU 响应 中断 后 在 中断 服务程序 里 对 相应 的 计数器 进行 最后 级 的 软件 计数 。 
 
 图 4 　 等 精度 测频 原理 电路图 
 　 　 图 4 是 等 精度 测频 原理 电路图 。 具体 测量 过程 如下 ： 
 　 　 1 . 测量 前 由 程序 先对 计数器 清零 ( 清 硬件 计数器 及 相应 的 RAM 单元 ) ， 控制 CPU 发出 复位 控制 信号 12H ， 通过 74LS174 复位 同步 门 控制器 74HC74 和 清零 前 级 分频 计数器 IC1 、 IC2 ， 禁止 CTC8254 三 通道 计数器 计数 。 D 触发器 门控 信号 Q 端 处于 低电平 ， 测量 阀门 时间 控制 信号 D 端 ( D0 线 ) 为 低电平 “ 0 ” ， Q 端 与 D 端 逻辑 状态 相同 ， 触发器 处于 闭锁 状态 ， 被测 信号 到达 D 触发器 的 CLK 端 并 不能 使 其 翻转 。 这时 同步 门 与 门 74HC08 处于 关闭 状态 ， 频标 信号 和 待测 信号 均 不能 进入 计数器 计数 。 
 　 　 2 . 测量 开始 时 ， 由 CPU 根据 程序 发出 的 指令 0DH ， 测量 阀门 时间 控制 信号 由 低电平 跳 变为 高电平 ， D 端 变为 高电平 “ 1 ” ， 一旦 有 被 测 信号 的 上升 沿 到达 CLK 端 ， 触发器 立即 翻转 ， Q 端 和 D 端 逻辑 状态 相同 ， 变为 高电平 “ 1 ” ， 触发器 解除 闭锁 ， 同步 门置位 被 打开 ， 允许 信号 进入 计数器 计数 ； 同时 ， CTC8254 计数器 和 前级 计数器 IC1 、 IC2 允许 计数 ； 硬件 阀门 时间 定时器 开始 计数 测量 预置 阀门 时间 。 
 　 　 3 . 同步 门 打开 后 ， 被测 信号 与 时间 信号 经 施密特 反相器 74HC14 整形 后 分别 进入 相应 的 计数器 进行 计数 。 在 计数 过程 中 同步 门 控制器 D 触发器 74HC74 的 D 端 保持 为 高电平 “ 1 ” ， 触发器 再次 处于 闭锁 状态 ， Q 端 输出 也 保持 为 高电平 “ 1 ” ， 同步 门 仍 保持 开门 状态 。 
 　 　 4 . 测量 预置 阀门 时间 到 以后 ， CPU 发出 控制 信号 1CH ， 使 测量 阀门 时间 控制 信号 恢复 到 低电平 ， 即 同步 门 控制器 D 输入 端为 低电平 “ 0 ” ， 因 同步 门 时钟 端 是 和 被 测 信号 连在一起 的 ， 所以 在 下 一个 待测 信号 的 上升 沿 到来 的 时候 ， 被测 信号 再次 触发 D 触发器 使 之 翻转 ， 输出 端 Q 为 低电平 “ 0 ” ， 同步 门 关闭 。 
 　 　 5 . 在 CPU 发出 控制 信号 到 同步 门 关闭 期间 ， 事件 计数器 、 时间 计数器 继续 计数 ； 同步 门 关闭 后 ， 停止 计数 。 
 　 　 6 . CPU 检测 同步 门 关闭 信号线 电平 ， 检测 到 同步 门 已经 关闭 后 即 从 总线 接口 读入 前 级 硬件 计数器 的 各计 数值 ， 与 后级 软件 计 数值 构成 一组 完整 的 计 数值 ， 再 转换 为 规格化 的 数据 ， 进行 运算 和 数据处理 ， 并 在 显示器 上 显示 经过 数据处理 后 的 测量 结果 。 
 　 　 7 . 下次 测量 过程 重复 上述 过程 。 
 3 　 测量 程序流程 
 　 　 智能 频率 测量 卡 的 软件 采用 BORLAND C++ 3.1 ， 模块化 结构设计 ， 整个 软件 由 顶向下 分层 分块 设计 ， 每个 模块 完成 一项 功能 。 其 功能 子程序 如图 5 。 如 要 扩充 其它 功能 ， 只要 编写 相应 的 功能 子 程序模块 加入 即可 。 
 
 图 5 等 精度 频率计 软件 功能 子程序 图 
 　 　 如 进一步 利用 微机 资源 ， 可以 微机 BIOS 的 INT15H 的 扩展 功能 实时 时钟 周期 中断 来 作 预置 阀门 时间 定时器 ， 可省 下 8254 的 通道 2 及其 前 级 计数器 ， 硬件 设计 更为 简单 。 当 建立 允许 中断 标志 后 ， 微机 实时 时钟 以 每隔 976.562 μ s 的 间隔 产生 实时 时钟 中断请求 信号 ， 并 引发 硬件 中断请求 IRQ8 。 中断 服务程序 判断 32 位 的 事件 等待 计数器 计 数值 是否 已到 设定 的 等待时间 ， 如是 ， 则 把 用户 指定 的 标记 单元 置 为 80H 。 由此 即可 设定 等待时间 为 预置 阀门 时间 ， 标记 单元 为 预置 时间 到 标志 ， 也 可 完成 预置 阀门 事件 定时器 的 功能 ， 且 在 各种 型号 的 微机 上 均 能 实现 和 正常 工作 。 
 　 　 通过 对 样机 的 调试 ， 高精度 频率 信号 测量 卡有 以下 特点 ： 
 　 　 ( 1 ) 采用 等 精度 测频法 ， 测量 精度高 ， 且 在 同一 阀门 时间 内 ， 频率 测量 精度 相等 。 当频标 信号 稳定度 为 10 - 7 、 阀门 时间 为 10s 时 ， 测频 精度 可达 10 - 6 。 
 　 　 ( 2 ) 测量 阀门 时间 可以 在 0.01 ～ 10.0 s 间 任意 设置 。 
 　 　 ( 3 ) 测频 范围 0.1 Hz ～ 40MHz 。 
 　 　 ( 4 ) 输入 频率 信号 全程 灵敏度 为 50mV 。 
 　 　 ( 5 ) 与 微机 结合 ， 智能化 程序 高 ， 具有 数据 记忆 及 处理 能力 。 
 　 　 ( 6 ) 如外 接高 稳定度 的 频标 信号源 ， 则 测频 精度 还 可 进一步提高 。 
 　 　 ( 7 ) 适用 于 任何 频率 输出 型 传感器 。 
 作者 单位 ： 张志明 　 西安 西北工业大学 519 # 信箱 ( 710072 ) 
 　 　 　 　 　 李蓉艳 　 西安 微电子 技术 研究所 ( 710054 ) 
 参考文献 
 1 　 陈成 . 微机 电子仪器 的 实用 设计 . 北京 ： 水利电力 出版社 
 2 　 张学庄 . 电子仪器 和 测量 原理 . 北京 ： 人民邮电出版社 
 3 　 董渭清 ， 王换 招 . 高档 微机 接口技术 与 应用 . 西安 ： 西安交通大学 出版社 
 ( 收稿 日期 ： 1998 - 07 - 13 ) 
